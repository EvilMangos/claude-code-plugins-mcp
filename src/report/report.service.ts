import { inject, injectable } from "inversify";
import { TOKENS } from "../container";
import type { GetReportResult } from "./types/get-report-result.interface";
import type { ReportRepository } from "./types/report.repository.interface";
import type { ReportService as ReportServiceInterface } from "./types/report.service.interface";
import type { SaveReportResult } from "./types/save-report-result.interface";
import { formatError } from "../utils/format-error";
import { validateInput } from "../utils/validate-input";
import { GetReportInput, getReportSchema } from "./schemas/get-report.schema";
import {
	SaveReportInput,
	saveReportSchema,
} from "./schemas/save-report.schema";

/**
 * Service for managing workflow reports.
 * Provides methods to save and retrieve reports from repository.
 */
@injectable()
export class ReportService implements ReportServiceInterface {
	constructor(
		@inject(TOKENS.ReportRepository)
		private readonly repository: ReportRepository
	) {}

	/**
	 * Save a workflow report to repository.
	 * @param input - The report input containing taskId, reportType, and content
	 * @returns A result object with success status and optional error message
	 */
	async saveReport(input: SaveReportInput): Promise<SaveReportResult> {
		const validation = validateInput(saveReportSchema, input);

		if (!validation.success) {
			return validation;
		}

		const validatedInput = validation.data;

		try {
			// Save to repository (timestamp is generated by repository)
			this.repository.save(
				validatedInput.taskId,
				validatedInput.reportType,
				validatedInput.content
			);

			return { success: true };
		} catch (error) {
			return {
				success: false,
				error: formatError(error),
			};
		}
	}

	/**
	 * Get a workflow report from repository.
	 * @param input - The report input containing taskId and reportType
	 * @returns A result object with success status and optional report or error message
	 */
	async getReport(input: GetReportInput): Promise<GetReportResult> {
		const validation = validateInput(getReportSchema, input);

		if (!validation.success) {
			return validation;
		}

		const validatedInput = validation.data;

		try {
			// Get report from repository
			const report = this.repository.get(
				validatedInput.taskId,
				validatedInput.reportType
			);

			if (report) {
				return { success: true, content: report.content };
			}

			// Report not found
			return { success: true, content: null };
		} catch (error) {
			return {
				success: false,
				error: formatError(error),
			};
		}
	}
}
