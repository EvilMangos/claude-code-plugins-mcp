import { reportRepository } from "../storage/report.repository";
import type { IGetReportResult } from "../types/get-report-result.interface";
import type { IReportService } from "../types/report-service.interface";
import type { ISaveReportResult } from "../types/save-report-result.interface";
import { formatStorageError } from "../utils/format-storage.error";
import { formatZodError } from "../utils/format-zod.error";
import { GetReportInput, getReportSchema } from "./schemas/get-report.schema";
import {
	SaveReportInput,
	saveReportSchema,
} from "./schemas/save-report.schema";

/**
 * Service for managing workflow reports.
 * Provides methods to save and retrieve reports from storage.
 */
class ReportServiceImpl implements IReportService {
	/**
	 * Save a workflow report to in-memory storage.
	 * @param input - The report input containing taskId, reportType, and content
	 * @returns A result object with success status and optional error message
	 */
	async saveReport(input: SaveReportInput): Promise<ISaveReportResult> {
		// Validate input
		const parseResult = saveReportSchema.safeParse(input);

		if (!parseResult.success) {
			return {
				success: false,
				error: formatZodError(parseResult.error),
			};
		}

		const validatedInput = parseResult.data;

		try {
			// Save to repository (timestamp is generated by repository)
			reportRepository.save(
				validatedInput.taskId,
				validatedInput.reportType,
				validatedInput.content
			);

			return { success: true };
		} catch (error) {
			return {
				success: false,
				error: formatStorageError(error),
			};
		}
	}

	/**
	 * Get a workflow report from in-memory storage.
	 * @param input - The report input containing taskId and reportType
	 * @returns A result object with success status and optional report or error message
	 */
	async getReport(input: GetReportInput): Promise<IGetReportResult> {
		// Validate input
		const parseResult = getReportSchema.safeParse(input);

		if (!parseResult.success) {
			return {
				success: false,
				error: formatZodError(parseResult.error),
			};
		}

		const validatedInput = parseResult.data;

		try {
			// Get report from repository
			const report = reportRepository.get(
				validatedInput.taskId,
				validatedInput.reportType
			);

			if (report) {
				return { success: true, content: report.content };
			}

			// Report not found
			return { success: true, content: null };
		} catch (error) {
			return {
				success: false,
				error: formatStorageError(error),
			};
		}
	}
}

/**
 * Singleton instance of ReportService.
 */
export const reportService: IReportService = new ReportServiceImpl();
