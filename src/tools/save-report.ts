import { reportRepository } from "../storage/report-repository";
import type { SaveReportResult } from "../types/save-report-result";
import { formatStorageError } from "../utils/format-storage-error";
import { formatZodError } from "../utils/format-zod-error";
import {
	SaveReportInput,
	saveReportSchema,
} from "./schemas/save-report.schema";

/**
 * Save a workflow report to in-memory storage.
 * @param input - The report input containing taskId, reportType, and content
 * @returns A result object with success status and optional error message
 */
export async function saveReport(
	input: SaveReportInput
): Promise<SaveReportResult> {
	// Validate input
	const parseResult = saveReportSchema.safeParse(input);

	if (!parseResult.success) {
		return {
			success: false,
			error: formatZodError(parseResult.error),
		};
	}

	const validatedInput = parseResult.data;

	try {
		// Save to repository (timestamp is generated by repository)
		reportRepository.save(
			validatedInput.taskId,
			validatedInput.reportType,
			validatedInput.content
		);

		return { success: true };
	} catch (error) {
		return {
			success: false,
			error: formatStorageError(error),
		};
	}
}
